name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Extract version from tag (v0.2.5 -> 0.2.5)
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      # Update version in pubspec.yaml from tag
      - name: Update version from tag
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Setting version to $VERSION from tag..."

          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          echo "Updated pubspec.yaml"

          # Update CHANGELOG.md - add new version if not present
          if ! grep -q "## $VERSION" CHANGELOG.md; then
            sed -i "s/# Changelog/# Changelog\n\n## $VERSION\n- Release version $VERSION/" CHANGELOG.md
            echo "Updated CHANGELOG.md"
          fi

          echo ""
          echo "All files updated to version $VERSION"

      # Commit version updates back to repo
      - name: Commit version updates
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No version changes needed (already at $VERSION)"
          else
            git add -A
            git commit -m "chore: bump version to $VERSION [skip ci]"

            # Push to the default branch
            DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
            git push origin HEAD:$DEFAULT_BRANCH
            echo "Version update committed and pushed"
          fi

      # Update tag to point to new commit (with version updates)
      - name: Update tag
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG_NAME="v$VERSION"

          # Delete and recreate tag at current commit
          git tag -d "$TAG_NAME" 2>/dev/null || true
          git push origin :refs/tags/"$TAG_NAME" 2>/dev/null || true
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "Tag $TAG_NAME updated to include version changes"

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Run analysis
      - name: Analyze
        run: flutter analyze

      # Run tests
      - name: Run tests
        run: flutter test

      # Dry run to verify package is ready
      - name: Verify package
        run: dart pub publish --dry-run

      # Setup pub.dev credentials
      - name: Setup pub.dev credentials
        run: |
          mkdir -p $HOME/.config/dart
          echo '${{ secrets.PUB_DEV_CREDENTIALS }}' > $HOME/.config/dart/pub-credentials.json

      # Publish to pub.dev
      - name: Publish to pub.dev
        run: dart pub publish --force

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Installation

            Add to your `pubspec.yaml`:

            ```yaml
            dependencies:
              flutter_ulink_sdk: ^${{ steps.version.outputs.VERSION }}
            ```

            Then run:
            ```bash
            flutter pub get
            ```

            ## Links
            - [pub.dev package](https://pub.dev/packages/flutter_ulink_sdk)
            - [Documentation](https://github.com/mohn93/flutter_ulink_sdk#readme)
