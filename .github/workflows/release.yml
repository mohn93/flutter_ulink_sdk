name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write

jobs:
  # Job 1: Update version files, run tests, create GitHub release
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Extract version from tag (v0.2.5 -> 0.2.5)
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      # Update version in pubspec.yaml from tag
      - name: Update version from tag
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Setting version to $VERSION from tag..."

          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          echo "Updated pubspec.yaml"

          # Update CHANGELOG.md - add new version if not present
          if ! grep -q "## $VERSION" CHANGELOG.md; then
            sed -i "s/# Changelog/# Changelog\n\n## $VERSION\n- Release version $VERSION/" CHANGELOG.md
            echo "Updated CHANGELOG.md"
          fi

          echo ""
          echo "All files updated to version $VERSION"

      # Commit version updates back to repo
      - name: Commit version updates
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No version changes needed (already at $VERSION)"
          else
            DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
            git fetch origin $DEFAULT_BRANCH

            git add -A
            git commit -m "chore: bump version to $VERSION [skip ci]"

            # Rebase onto remote branch to handle the case where the bump
            # was already pushed by a previous run (makes retries safe)
            git rebase origin/$DEFAULT_BRANCH || {
              echo "Rebase conflict â€” version bump likely already on $DEFAULT_BRANCH, skipping push"
              git rebase --abort
              git checkout origin/$DEFAULT_BRANCH -- pubspec.yaml CHANGELOG.md
              exit 0
            }

            git push origin HEAD:$DEFAULT_BRANCH
            echo "Version update committed and pushed"
          fi

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Run analysis
      - name: Analyze
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      # Run tests
      - name: Run tests
        run: flutter test

      # Dry run to verify package is ready
      - name: Verify package
        run: dart pub publish --dry-run

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Installation

            Add to your `pubspec.yaml`:

            ```yaml
            dependencies:
              flutter_ulink_sdk: ^${{ steps.version.outputs.VERSION }}
            ```

            Then run:
            ```bash
            flutter pub get
            ```

            ## Links
            - [pub.dev package](https://pub.dev/packages/flutter_ulink_sdk)
            - [Documentation](https://github.com/mohn93/flutter_ulink_sdk#readme)

  # Job 2: Publish to pub.dev using official Dart workflow with OIDC
  publish:
    needs: build-and-release
    permissions:
      id-token: write  # Required for authentication using OIDC
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
